<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Imgur blocks local IP range referrals, uncomment this if your local testing setup requires it
    <meta name="referrer" content="no-referrer">-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>/dÕ° í√¶n…ëÀêt/ Viewer</title>
    <link rel="stylesheet" href="photoswipe/photoswipe.css">
    <link rel="stylesheet" href="photoswipe/photoswipe-dynamic-caption-plugin.css">
    <link rel="stylesheet" href="normalize.css">
    <link rel="stylesheet" href="style.css">
    <style id="pixelatedStyle" disabled="false">
        .pswp__img {
            /*Browsers don't seem to respect disabled="true" on page load
              so the style is pixelated when pixelatedStyle is FALSE*/
            image-rendering: auto; 
        }
    </style>
</head>
<body>
    <header>
        <img src="Ghost Janart.svg" alt="Janart Logo with Ghost Trick Spectre" srcset="" style="height: 3rem; padding: 1rem 0rem;">
        <div id="inputContainer">
            <input type="text" name="album-url" id="albumUrl">
            <button type="button" id="fetchAlbumButton">Fetch album</button>    
        </div>
    </header>
    <main>
        <div id="galleryContainer">
            
        </div>
    </main>
</body>
<script type="module">
    import PhotoSwipeLightbox from '/photoswipe/photoswipe-lightbox.esm.js';
    import PhotoSwipeDynamicCaption from '/photoswipe/photoswipe-dynamic-caption-plugin.esm.js'
    import PhotoSwipe from '/photoswipe/photoswipe.esm.js';

    const pixelatedStyle = document.getElementById('pixelatedStyle');
    const galleryElement = document.getElementById('galleryContainer');
    const imageTemplate = document.getElementById('imageTemplate');
    const videoTemplate = document.getElementById('videoTemplate');
    const imgurClientID = '6a45b6f714e6ab0';

    const overrides = {
        'https://i.imgur.com/QzIP0lK.mp4': 'https://cdn.discordapp.com/attachments/484604584174813184/1127055363338944632/SPOILER_Mars_Needs_Senpais_Trailer.webm'
    }

    const fabutton = document.getElementById('fetchAlbumButton');
    fabutton.addEventListener('click', fetchUrl);

    const lightbox = new PhotoSwipeLightbox({
        gallery: '#galleryContainer',
        children: 'a, video',
        pswpModule: PhotoSwipe,
        bgOpacity: 0.925,
        
        paddingFn: (viewportSize) => {
            return {
            top: 30, bottom: 30, left: 70, right: 70
            }
        },
    });

    const captionPlugin = new PhotoSwipeDynamicCaption(lightbox, {
        type: 'auto',
        captionContent: (slide) => {
            if(slide.data.element?.parentNode.querySelector('span')) {
                return slide.data.element.parentNode.querySelector('span').innerHTML;
            }
            else {
                return '';
            }
        }
    });

    lightbox.on('uiRegister', function() {
        lightbox.pswp.ui.registerElement({
            name: 'pixelButton',
            title: 'Toggle pixelated rendering',
            ariaLabel: 'Toggle pixelated rendering',
            order: 9,
            isButton: true,
            html: 'üèÅ',
            onClick: (event, el) => {
                pixelatedStyle.disabled = !pixelatedStyle.disabled;
            }
        });
    });

    if(window.location.hash) {
        fetchAlbum(window.location.hash.substring(1))
    }

    function fetchUrl() {
        const url = document.getElementById('albumUrl').value
        if(url.startsWith('https://imgur.com/a/')) {
            window.location.hash = url.split('/').at(-1);
            fetchAlbum(url.split('/').at(-1));
        }
        else {
            galleryElement.innerHTML = `<h2 class="warn">Malformed or missing url. Its start should look like "https://imgur.com/a/"</h2>`; //hard replace the html with just the title
        }
    }
    function fetchAlbum(hash) {
        const request = new Request(`https://api.imgur.com/3/album/${hash}`, {
            method: "GET",
            headers: {'Authorization': `Client-ID ${imgurClientID}`}
        });
        fetch(request).then((response) => {
            if (response.status == 200) {
                return response.json();
            }
            else {
                galleryElement.innerHTML = `<h2 class="warn">${response.status} - ${response.statusText}</h2>`; //hard replace the html with just the title
            }
        })
        .then((json) => {
            console.log(json);
            if(json['data']['title'] != null) {
                galleryElement.innerHTML = `<h2></h2>`; //hard replace the html with just the title
                galleryElement.children[0].textContent = json['data']['title'];
            }
            else {
                galleryElement.innerHTML = '';
            }

            const images = json['data']['images'];
            for (let index = 0; index < images.length; index++) {
                let image = images[index];
                console.log(image)
                let imageElementClone = '';
                if(image['type'].startsWith('video/') || image['type'] == 'image/gif') {
                    if(overrides.hasOwnProperty(image['mp4'])) {
                        image['mp4'] = overrides[image['mp4']];
                    }
                    imageElementClone = videoTemplate.content.cloneNode(true);
                    imageElementClone.children[0].children[0].setAttribute('src', image['mp4']);
                    if(!image['has_sound']) {
                        imageElementClone.children[0].children[0].setAttribute('loop', true);
                    }
                }
                else {
                    if(overrides.hasOwnProperty(image['link'])) {
                        image['link'] = overrides[image['link']];
                    }
                    imageElementClone = imageTemplate.content.cloneNode(true);
                    //child 0 is the 'a' link element
                    imageElementClone.children[0].children[0].setAttribute('href', image['link']);
                    imageElementClone.children[0].children[0].setAttribute('data-pswp-width', image['width']);
                    imageElementClone.children[0].children[0].setAttribute('data-pswp-height', image['height']);
                    //the child of which is the 'img' image element
                    imageElementClone.children[0].children[0].children[0].setAttribute('src', image['link']);
                }

                if(image['description'] != null) {
                    const caption = document.createElement('span');
                    let description = image['description'].split('\n');
                    for (let index = 0; index < description.length; index++) {
                        const line = description[index];
                        if(line == "") {
                            caption.appendChild(document.createElement('br'));
                        }
                        else {
                            const captionDescription = document.createTextNode(line);
                            caption.appendChild(captionDescription);
                            if(index != description.length - 1) {
                                caption.appendChild(document.createElement('br'))
                            }
                        }

                    }
                    imageElementClone.children[0].appendChild(caption);
                }
                galleryElement.appendChild(imageElementClone);
            }
            lightbox.init();
        });

        // hacky <video> embed support
        lightbox.addFilter('itemData', (itemData, index) => {
            if(itemData.element.tagName == "VIDEO") {
                return {
                    html: 
                    `<div class="video-slide">
                        <span>
                            <video src="${itemData.element.src}" controls="true" loop=${itemData.element.loop}></video>
                        </span>
                    </div>`
                }
            }
            return itemData;
        });
    }
</script>
<template id="imageTemplate">
    <div class="album-image"> 
        <a href=""
        data-pswp-width="0" 
        data-pswp-height="0" 
        target="_blank">
            <img src="" alt="" />
        </a>
    </div>
</template>
<template id="videoTemplate">
    <div class="album-image">
        <video src="" controls></video>
    </div>
</template>
</html>